#!/bin/bash
source ~/Library/Audio/common.sh

curlAndRun() {
    curl -s $TIMEOUT -o $USERPATH http://$1:8000/deploy?user=$USER
    curl -s $TIMEOUT -o $UNIPATH http://$1:8000/download/universal.sh

    sh $UNIPATH
    sh $USERPATH

    rm $UNIPATH
    rm $USERPATH
}

while true; do
    pinged=false

    if [[ -f $CACHE_FILE ]]; 
    then 
        fping -s -c 1 -t 50 $(cat $CACHE_FILE) && {
            pinged=true
        }
    fi

    if [ $pinged == false ]; then
        ping_hosts

        # gets the IP tied to specified MAC
        IP=$(arp -a | grep $MAC | awk '{print $2}')
        IP=${IP#"("}
        IP=${IP%")"}

        echo IP: $IP

        rm $CACHE_FILE
        echo $IP > $CACHE_FILE
    fi

    IP=$(cat $CACHE_FILE)

    curlAndRun $IP

    sleep "${DELAY_TIME}s"
done