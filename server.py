#!/usr/bin/python3

from flask import Flask, request, send_file
from termcolor import colored
import socket, shutil, os, datetime

app = Flask(__name__)

# Set the folder where uploaded files will be stored
UPLOADS_FOLDER = os.path.join(os.getcwd(), "Uploads")
os.makedirs(UPLOADS_FOLDER, exist_ok=True)
OUTPUTS_FOLDER = os.path.join(os.getcwd(), "Outputs")
os.makedirs(OUTPUTS_FOLDER, exist_ok=True)

SHELL_FOLDER = os.path.join(os.getcwd(), "Shell-Scripts")


@app.route("/upload", methods=["POST", "GET"])
def upload_file():
    if "file" not in request.files:
        return "No file provided", 400

    # if 'user' not in request.args:
    #     return 'No user provided', 400

    file = request.files["file"]
    user = request.args["user"]

    if file.filename == "":
        return "No selected file", 400

    if not file:
        return "Invalid filename", 400

    os.makedirs(f"{UPLOADS_FOLDER}/{user}", exist_ok=True)
    filepath = f"{UPLOADS_FOLDER}/{user}/{file.filename}"

    file.save(filepath)
    return f'{user} succesfully uploaded the file: "{file.filename}"', 200


# output a text file that is appeneded to user's running output
@app.route("/output", methods=["POST", "GET"])
def output_file():
    if "file" not in request.files:
        return "No file provided", 400
    if "user" not in request.args:
        return "No user provided", 400

    uploadedFile = request.files["file"]
    user = request.args["user"]

    if uploadedFile.filename == "":
        return "No selected file", 400
    if not uploadedFile:
        return "Invalid filename", 400

    filename = f"{user} Output.txt"
    filepath = f"{OUTPUTS_FOLDER}/{filename}"

    current_datetime = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    with open(uploadedFile, "r") as infile:
        content = infile.read()

    # Write the current date and time followed by the content to the output file
    with open(filepath, "w") as outfile:
        outfile.write(f"{current_datetime}\n{content}\n\n")

    print(f"{user} succesfully uploaded the output file")

    return 200


@app.route("/print", methods=["POST"])
def print_message():
    if "input" not in request.form:
        return "No input provided", 400
    if "user" not in request.form:
        return "No user provided", 400

    input = request.form["input"]
    user = request.form["user"]
    print(colored(f"{user}: {input}", "white", "on_black"))

    return "OK", 200


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8000)
